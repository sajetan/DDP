#include "common.h"

#include "hw_accelerator.h"
#include <stdint.h>
#include <inttypes.h>
#include "test.h"

// These variables are defined in the testvector.c
// that is created by the testvector generator python script
extern uint32_t N[32],		// modulus
                e[32],		// encryption exponent
                e_len,		// encryption exponent length
                d[32],		// decryption exponent
                d_len,		// decryption exponent length
                M[32],		// message
                R_1024[32],	// 2^1024 mod N
                R2_1024[32];// (2^1024)^2 mod N


// Uncomment for Session SW2 onwards
#include "mp_arith.h"
#include "montgomery.h"
#include "asm_func.h"

void print_num(uint32_t *in, uint32_t size)
{
    int32_t i;

    xil_printf("0x");
    for (i = size-1; i >= 0; i--) {
    	xil_printf("%08x", in[i]);
    }
    xil_printf("\n\r");
}



int main()
{
    init_platform();
    init_performance_counters(1);

    xil_printf("Begin\n\r");

START_TIMING
    	xil_printf("Hello World\n\r");
STOP_TIMING

	xil_printf("If the FPGA is not programmed, the program will stuck here!\n\r");


#if 0
	// SW2: multi-precision add/sub
	//----------------------

    //add
    xil_printf("\r\nMP_ADD");
    uint32_t a1[32]   = { 0x5fb6d493, 0xdb0ee8be, 0x704a841e, 0xd09b1f41, 0xcf4f3870, 0xa0d90b3f, 0xdd34e375, 0x02c71f50, 0xbbe0bf21, 0x4cf7dd68, 0xdc580789, 0x9ee98638, 0x708b655f, 0x09c9cf5d, 0x6cbcb152, 0x2988bd7f, 0xa2883faa, 0xbb82748d, 0x9ab7bce3, 0x5dbe293f, 0x52322bd8, 0xaeffcd83, 0xee533ae0, 0x4d4ba990, 0x90ab358f, 0x8e7ff46d, 0xc1b445a6, 0x514f1554, 0x1ae5c5ef, 0xc5dc5c9d, 0x735ad8f6, 0x86580beb };
    uint32_t b1[32]   = { 0x3cf8d180, 0xe7f5a608, 0xc4b6a195, 0xc79d0d06, 0x84b0cdf3, 0x3e5105ed, 0xf06ba2e7, 0x6e29295e, 0x7a6bf7af, 0xfbcb45ef, 0x23192140, 0x173cb903, 0xfb3b0025, 0x419641aa, 0x62c5eae8, 0xa8b835dd, 0xc1b87288, 0x3f262083, 0x27816323, 0x2f7ca6e8, 0x55dc4b30, 0xfff8ded8, 0x1ba1bdf5, 0x5d4bb174, 0x538c03cf, 0x8e853091, 0x48d23333, 0xd3ca9ba6, 0x232b5d61, 0x31758358, 0x118250c0, 0xed8c5aa0 };
	uint32_t res1[33] = { 0x0};

START_TIMING
	mp_add(a1, b1, res1,32);
STOP_TIMING
	xil_printf("\r\nA=");
	print_num(a1, 32);
	xil_printf("B=");
	print_num(b1, 32);
	xil_printf("A+B=");
	print_num(res1, 33);


    //sub
    xil_printf("\r\nMP_SUB");
    uint32_t a2[32]   = { 0xfb7345ad, 0xa972161a, 0x56e7c032, 0xab115e34, 0x54edb161, 0x090b2cd8, 0xb38355cf, 0xfc215f78, 0x02b48c2b, 0x1cf2febf, 0x05f6c7cb, 0xfecea88b, 0x79f6ccea, 0x41258aef, 0x1700ee12, 0x9cf2fab6, 0x81a88642, 0x98df2823, 0xed1154ad, 0xf1bfd75a, 0x51d6de5b, 0xfb808b5f, 0xa622f7c1, 0x5e863645, 0x50142423, 0x9f1313bc, 0xcfef6e97, 0xdd0c07bd, 0x52222e67, 0x02ec3add, 0x06f7ef59, 0x8188c6ab };
    uint32_t b2[32]   = { 0x47f1272b, 0x3f499d07, 0xdc6d6ab3, 0x67ea2462, 0xa8e7a7d8, 0xe4606bb1, 0xcdf2a51f, 0x664b9758, 0x24302a2b, 0xdb256daf, 0xe1e72364, 0x540ba351, 0xad632f6b, 0x715f7e93, 0x91ccd071, 0x11b55bc7, 0xb8444a26, 0xe93a5379, 0x5b96d885, 0xd2d93a5f, 0x2e388bb5, 0x481ae889, 0xa97cc5c6, 0x3c2a5d0a, 0xb6f2b677, 0x02dec0fe, 0xab536a25, 0x5c57a3ed, 0x372426a1, 0x5c718d06, 0x3483f275, 0x802edb99 };
	uint32_t res2[32] = { 0x0};

START_TIMING
	mp_sub(a2, b2, res2,32);
STOP_TIMING
	xil_printf("\r\nA=");
	print_num(a2, 32);
	xil_printf("B=");
	print_num(b2, 32);
	xil_printf("A-B=");
	print_num(res2, 32);

	//mod_add
	xil_printf("\r\nMOD_ADD");


	uint32_t a3[32]   = { 0xa2e47eba, 0xdb5e3e7d, 0x5fd9a7cb, 0x9e7a37c3, 0x4dc37416, 0x834fe315, 0x0080dbac, 0x47280a4d, 0x722dc3dd, 0x7f0ca6f4, 0x7f0da3db, 0xfc20cbb9, 0xb749699e, 0xc5abc925, 0x8bc67669, 0x23a30d3f, 0xffe44e1c, 0xdb22d6ee, 0x5dc3d3b3, 0xfe7e980d, 0x894075d2, 0xdeabe7c4, 0x58042c3b, 0x1cc18107, 0xf0abb2e1, 0x7bd31dc0, 0x72355db9, 0xf55a0178, 0x99f5d831, 0x12ccb47a, 0x44eef089, 0x81bf5831 };
	uint32_t b3[32]   = { 0xe47d092a, 0xd7615ed9, 0xa8aff661, 0xc3d7bb8c, 0x2d22b31c, 0x5050b808, 0xb0bc44bb, 0x93e46f4f, 0xac0332e5, 0x81ad7f85, 0x23de9197, 0x4b35f0a2, 0x6303744a, 0x615740bf, 0x54ebbaef, 0xf36273c2, 0xaf0d1080, 0x4740c9d6, 0x458e6699, 0xaaa1040b, 0x614df162, 0xaf7fe30d, 0xac73e3ed, 0x49204145, 0x1653523c, 0x5ee4f3b1, 0x2b3f4339, 0x5b9a2426, 0x62e3ffb3, 0xf4c32df1, 0x94f2db82, 0x80deb209 };
	uint32_t N3[33]   = { 0xb2e52d11, 0x8f850a5f, 0x08edfb0c, 0x4f02a1ac, 0xdd070636, 0x6c59cfc8, 0x16a40db7, 0x85bba009, 0x598eba07, 0x5d0fa3cc, 0x32bc6fb5, 0x4aa27cd0, 0x0928454e, 0x027d3081, 0xd1caec35, 0xa98e4223, 0x533983de, 0x36370bb4, 0xe8b0b4c6, 0xfe3655ab, 0x27a4a51e, 0xb403c449, 0xa679cf3b, 0xc1fc4391, 0x884e5080, 0xa65d4d30, 0xcd90ed67, 0x55fcb457, 0x989d6f4c, 0x0303d70e, 0x9a09328e, 0x82260dd0, 0x0};
	uint32_t res3[33];
	uint32_t size=32;
START_TIMING
	mod_add(a3,b3,N3, res3, size);
STOP_TIMING
	xil_printf("\r\nA=");
	print_num(a3, 32);
	xil_printf("B=");
	print_num(b3, 32);
	xil_printf("N=");
	print_num(N3, 32);
	xil_printf("(A+B)modN=");
	print_num(res3, 32);


    //mod_sub
    xil_printf("\r\nMOD_SUB");
    uint32_t a4[32]   = { 0x58dbf779, 0x575740d6, 0x22f5f4ff, 0xfee2f9aa, 0xdfd7d85e, 0x6369df65, 0xdf4779e8, 0xefaca94e, 0xa685d499, 0xe4106396, 0x5909a0d5, 0x221befa0, 0x6ebbafcf, 0x31bdd396, 0xda56c836, 0x92800aa3, 0xecda33ae, 0x93e427b6, 0x092c226b, 0x4c7a5e39, 0x4df34625, 0x5fbaa5e8, 0x2a1ae27f, 0xbf51041f, 0x77437504, 0x60e47fed, 0xc677ca07, 0x336b2407, 0x255fdade, 0xdb69e9d1, 0x7588fd3b, 0x83433479 };
    uint32_t b4[32]   = { 0xa77c16c5, 0xfa4935b5, 0xc154ec99, 0x301e2643, 0xb8b8fbdf, 0xc3c8eda2, 0x3d1a8f84, 0x534e3da3, 0x87e0e5da, 0x85c63921, 0x1a47cdf4, 0xc0c2b332, 0xe8ff04bd, 0x0c36bd23, 0xa3c96c3e, 0x308ac41b, 0x2511d7fb, 0x716a9fa9, 0x2418ed5d, 0xcc81526b, 0xc9bbff34, 0x1d8b7599, 0x7eca3082, 0xa026b29d, 0x8377813d, 0x6dba7575, 0x08b7a520, 0xcafc2de6, 0xbf13cec1, 0x4479cc1a, 0xc3ecace7, 0x80b9fa75 };
    uint32_t n4[32]   = { 0xb672e01f, 0x92e9ace2, 0x0ab61389, 0x1302d058, 0x13a6ee9b, 0xfdfb1d3f, 0x2606e136, 0x5317fd7c, 0x4583fe0a, 0xccef8929, 0xf4d2744a, 0x0f13745c, 0xf6641cbe, 0x047608d8, 0xdb7b6221, 0xa2ef20b0, 0x14e04fad, 0x3350974c, 0x0f457ad3, 0xd0ae6914, 0xad9aecc8, 0xe87a5989, 0x92705dc5, 0x8efe769e, 0xfcc342dd, 0x62c646fd, 0x3f7d0ff3, 0xd3af71f1, 0x56483141, 0x0b516398, 0x288a7cfe, 0x83b3d8eb };
    uint32_t res4[32] = { 0x0};

//#if 0
START_TIMING
	mod_sub(a4, b4, n4, res4,32);
STOP_TIMING
	xil_printf("\r\nA=");
	print_num(a4, 32);
	xil_printf("B=");
	print_num(b4, 32);
	xil_printf("N=");
	print_num(n4, 32);
	xil_printf("(A-B)modN=");
	print_num(res4, 32);
#endif

/*--------------------------------------------------------------------------------------------------------
 * Montgomery Multiplication
--------------------------------------------------------------------------------------------------------*/
    xil_printf("\r\nMontgomery Multiplication\r\n");
    uint32_t a[32]         = { 0xa2e47eba, 0xdb5e3e7d, 0x5fd9a7cb, 0x9e7a37c3, 0x4dc37416, 0x834fe315, 0x0080dbac, 0x47280a4d, 0x722dc3dd, 0x7f0ca6f4, 0x7f0da3db, 0xfc20cbb9, 0xb749699e, 0xc5abc925, 0x8bc67669, 0x23a30d3f, 0xffe44e1c, 0xdb22d6ee, 0x5dc3d3b3, 0xfe7e980d, 0x894075d2, 0xdeabe7c4, 0x58042c3b, 0x1cc18107, 0xf0abb2e1, 0x7bd31dc0, 0x72355db9, 0xf55a0178, 0x99f5d831, 0x12ccb47a, 0x44eef089, 0x81bf5831 };
    uint32_t b[32]         = { 0xe47d092a, 0xd7615ed9, 0xa8aff661, 0xc3d7bb8c, 0x2d22b31c, 0x5050b808, 0xb0bc44bb, 0x93e46f4f, 0xac0332e5, 0x81ad7f85, 0x23de9197, 0x4b35f0a2, 0x6303744a, 0x615740bf, 0x54ebbaef, 0xf36273c2, 0xaf0d1080, 0x4740c9d6, 0x458e6699, 0xaaa1040b, 0x614df162, 0xaf7fe30d, 0xac73e3ed, 0x49204145, 0x1653523c, 0x5ee4f3b1, 0x2b3f4339, 0x5b9a2426, 0x62e3ffb3, 0xf4c32df1, 0x94f2db82, 0x80deb209 };
    uint32_t n[32]         = { 0xb2e52d11, 0x8f850a5f, 0x08edfb0c, 0x4f02a1ac, 0xdd070636, 0x6c59cfc8, 0x16a40db7, 0x85bba009, 0x598eba07, 0x5d0fa3cc, 0x32bc6fb5, 0x4aa27cd0, 0x0928454e, 0x027d3081, 0xd1caec35, 0xa98e4223, 0x533983de, 0x36370bb4, 0xe8b0b4c6, 0xfe3655ab, 0x27a4a51e, 0xb403c449, 0xa679cf3b, 0xc1fc4391, 0x884e5080, 0xa65d4d30, 0xcd90ed67, 0x55fcb457, 0x989d6f4c, 0x0303d70e, 0x9a09328e, 0x82260dd0 };
    uint32_t n_prime[32]   = { 0xfb5c9c0f, 0xd3cbec85, 0x3a126c50, 0x0f85259a, 0xb93b900a, 0x89feafbe, 0x30847469, 0x0a87f885, 0x9d5bfa86, 0xec1adae0, 0x448a3dac, 0xa7194e08, 0x61c37198, 0xd5eff8a8, 0xf96efef1, 0x473d83aa, 0xe7c048dd, 0xb1893377, 0xc843e910, 0xcd3b86d2, 0x2119b9dd, 0x6caed27a, 0x7ebcc873, 0x2019cd09, 0x240e3495, 0x040754fb, 0xdfef2830, 0x32a287d7, 0x8e79f7e4, 0x3daeb7e0, 0xbeaeac00, 0x376725cd };
    uint32_t eres[32]       = { 0x919af36d, 0x201c5a15, 0x763debb4, 0x54b92abd, 0xc3d09af8, 0x0269454a, 0x35a42e09, 0x1149a6e6, 0x381cfa5b, 0x61b91a68, 0x7180faf5, 0x8c7536c6, 0x0368f56d, 0x0ce9c2ab, 0xd6180f19, 0x0cf8b5ac, 0x62ca69e8, 0x8789e2ec, 0x080ca2ea, 0x4dea79c7, 0xf3b4499d, 0xbae3cd24, 0x148e24af, 0x83e7cc56, 0x22548763, 0x1e0f13bf, 0xc6b26d8e, 0xfc9c092d, 0x8fa70ce2, 0xb5098439, 0x9f7d1f55, 0x50a9e0c6 };


//seed which uses subtraction
//    uint32_t a[32]         = { 0x44b4e4e7, 0x88bc39f9, 0x2c7ba839, 0x7e907698, 0x06c5d272, 0xe0eb8d52, 0xad0f55c4, 0x016f88fa, 0x8ae5b81f, 0x7a94a5ab, 0xadca7bc6, 0x1422f732, 0xba5eaa00, 0x3a29aceb, 0xf2a9a27b, 0x9f011a21, 0x084eda88, 0x541946cd, 0x801db6e1, 0x5ecaaa4c, 0x2d9ce96a, 0x9ecce63b, 0x16cfc1d6, 0xf7525344, 0x0b11635f, 0xf9e0518f, 0x888eb7fc, 0x4cb8e3d5, 0x32793870, 0x41129b16, 0x0dc21fd0, 0x8804c294 };
//    uint32_t b[32]         = { 0x8782e553, 0x040d001f, 0x2365bbf5, 0xa3885a02, 0xa6e86b43, 0x9227c087, 0x65e83b11, 0x75a00a4d, 0x5b55acd2, 0xc3462ffa, 0x8e2cfbfb, 0xe096c676, 0x86a6564e, 0xed4a88e7, 0xcef87b13, 0xf2dbe92f, 0xf86a5dd7, 0xbb3e9e00, 0x4a4682dc, 0xfc4f3132, 0x1ae297aa, 0xdbb9b1a1, 0x3d82d59a, 0xa75972e0, 0x40ba342f, 0xb751c2cf, 0x640819a5, 0xe5594455, 0x393c5ec6, 0xe0171d30, 0xf3fdae27, 0x8a7e8b09 };
//    uint32_t n[32]         = { 0x48f30bdd, 0x61d8056e, 0x88513c8e, 0x6799a4a8, 0xa1f3c20e, 0x0865e24c, 0x56565486, 0xc3c30568, 0xb0f3fe10, 0xe6e871bc, 0x37ac80db, 0x97261b02, 0xbdba26a5, 0x43fb6965, 0xd06caba7, 0xeec2f91c, 0x32dad7c5, 0xf64ea5db, 0x44ebe4c3, 0x46372df4, 0x06ecba51, 0x3c56d4f6, 0x9ebd4230, 0x81059ecf, 0x5bc93856, 0x313429de, 0x0c3d752e, 0x49bd06c9, 0xea19ced8, 0x9a9dad83, 0x51f49334, 0x981d5fd1 };
//    uint32_t n_prime[32]   = { 0x59855b8b, 0x3cd6f7c7, 0x43c80802, 0x9a40cca3, 0xeed52707, 0x87547a81, 0xd41e8ac2, 0xc90b7cb5, 0x338059cd, 0xf2a04202, 0x70307b8a, 0xe2e3cc5a, 0xbccbbc35, 0x66639057, 0xf0d5f995, 0x99b7eecb, 0x5a8eb053, 0x5d5c3d0d, 0x1507dfa9, 0x2806bc87, 0xfc5c11c3, 0xedb48dce, 0x3ddc746b, 0x921b99c7, 0xf0e41fd8, 0x35d9bcc7, 0x07aeb6d3, 0x30b79b6f, 0xfed10adb, 0xed0f06db, 0xeed3bf77, 0x7a4a9b5f };
//    uint32_t eres[32]       = { 0x80fcf615, 0xb420e443, 0x3469f108, 0x7088e01f, 0xf641d1a9, 0xf38fa6aa, 0x37937c9c, 0xc3bb87c4, 0x344b1162, 0xca037d5c, 0xef1c148a, 0x36696594, 0x212f94aa, 0x3ccb731f, 0xc0fc1998, 0x2ab59696, 0x31ef73d7, 0x1b22596b, 0x53a494be, 0x0b0e3fd0, 0x1609c8a8, 0xc9470a65, 0xf0c6b40c, 0xb0b16dc5, 0xb55f5903, 0xbd3b9a2f, 0xd34ace7a, 0x16d7976f, 0x6ac5a689, 0x35d7ab48, 0x51652767, 0x15dfedf3 };

    uint32_t res[32]={0};
    uint32_t size = 32;



	xil_printf("\r\nA=");
	print_num(a, 32);
	xil_printf("B=");
	print_num(b, 32);
	xil_printf("eres =");
	print_num(eres, 32);
	xil_printf("\n\r");

   //START_TIMING
   //this uses optimized montgomery multiplication
   //montMulOpt(a, b, n, n_prime, res, size);
   //STOP_TIMING

    //START_TIMING
    //this uses non-optimized montgomery multiplication
  	//montMul(a, b, n, n_prime, res, size);
    //STOP_TIMING


	xil_printf("res =");
	print_num(res, 32);
	xil_printf("\n\r");

	uint32_t *tres=mont_exp( expres,  M, N, N_prime, R_1024,R2_1024,  size);

	xil_printf("trets =");
	print_num(tres, 32);
	xil_printf("\n\r");


#if 0
    init_HW_access();
	xil_printf("It did not stuck and HW is initialized!\n\r");


    example_HW_accelerator();


    xil_printf("End\n\r");
#endif

    cleanup_platform();

    return 0;
}
